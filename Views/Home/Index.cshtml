@{
    ViewData["Title"] = "Video Upload & Convert";
}

<h2>Upload and Convert Video</h2>

@if (!string.IsNullOrEmpty(ViewBag.ErrorMessage))
{
    <div class="alert alert-danger">
        @ViewBag.ErrorMessage
    </div>
}

@if (!string.IsNullOrEmpty(ViewBag.FileName))
{
    <div class="alert alert-success">
        File uploaded successfully: @ViewBag.FileName
    </div>

    <!-- Conversion Form -->
    <form asp-action="Convert" method="post" id="convertForm">
        <div class="form-group">
            <label for="targetFormat">Select Target Format</label>
            <select class="form-control" id="targetFormat" name="targetFormat">
                <option value="mp4">MP4</option>
                <option value="avi">AVI</option>
                <option value="mov">MOV</option>
                <option value="wmv">WMV</option>
                <option value="flv">FLV</option>
                <!-- Add other formats as needed -->
            </select>
        </div>

        <input type="hidden" name="fileName" value="@ViewBag.FileName" />
        <button type="submit" class="btn btn-primary">Convert</button>
    </form>

    <!-- *** Progress Bar Section *** -->
    <div id="progressBarContainer" class="mt-3" style="display: none;">
        <div class="progress">
            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                 role="progressbar" style="width: 100%;">
                Converting...
            </div>
        </div>
    </div>
}

 @* <h3>Upload Video (Drag and Drop)</h3> *@
<form id="uploadForm" asp-action="Upload" method="post" enctype="multipart/form-data">
    <div id="drag-and-drop-area" class="form-group" style="border: 2px dashed #ccc; padding: 20px; text-align: center;">
        <h4>Drag and drop your video file here</h4>
        <p>or</p>
        <input type="file" class="form-control" id="videoFile" name="videoFile" style="display:none;" />
        <button type="button" id="selectFileBtn" class="btn btn-primary">Select File</button>
    </div>
    <p id="fileNameDisplay"></p>
    <button type="submit" id="uploadBtn" class="btn btn-primary" style="display:none;">Upload</button>
</form>

<script>
    // Drag and Drop Area Handlers
    const dropArea = document.getElementById("drag-and-drop-area");
    const fileInput = document.getElementById("videoFile");
    const uploadBtn = document.getElementById("uploadBtn");
    const fileNameDisplay = document.getElementById("fileNameDisplay");
    const selectFileBtn = document.getElementById("selectFileBtn");
    const progressBarContainer = document.getElementById("progressBarContainer");

    dropArea.addEventListener("dragover", (event) => {
        event.preventDefault();
        dropArea.style.backgroundColor = "#f0f0f0";
    });

    dropArea.addEventListener("dragleave", () => {
        dropArea.style.backgroundColor = "";
    });

    dropArea.addEventListener("drop", (event) => {
        event.preventDefault();
        dropArea.style.backgroundColor = "";
        const file = event.dataTransfer.files[0];
        if (file) {
            fileInput.files = event.dataTransfer.files;
            fileNameDisplay.textContent = `Selected file: ${file.name}`;
            uploadBtn.style.display = "inline";
        }
    });

    selectFileBtn.addEventListener("click", () => {
        fileInput.click();
    });

    fileInput.addEventListener("change", () => {
        const file = fileInput.files[0];
        if (file) {
            fileNameDisplay.textContent = `Selected file: ${file.name}`;
            uploadBtn.style.display = "inline";
        }
    });

    // Show progress bar on form submission
    const convertForm = document.getElementById("convertForm");
    if (convertForm) {
        convertForm.addEventListener("submit", (event) => {
            progressBarContainer.style.display = "block"; // Show the progress bar
        });
    }

    // *** Hide progress bar on page load if conversion is complete ***
    window.addEventListener("load", () => {
        const downloadLink = document.querySelector(".alert-info a");
        if (downloadLink) {
            progressBarContainer.style.display = "none"; // Hide progress bar after conversion completes
        }
    });
</script>

@if (!string.IsNullOrEmpty(ViewBag.DownloadFileName))
{
    <div class="alert alert-info">
        <p>Conversion complete! <a href="@Url.Action("Download", "Home", new { fileName = ViewBag.DownloadFileName })">Download your file</a></p>
    </div>
}
